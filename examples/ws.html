<!DOCTYPE html>
<html>
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <title>Klang(金浪)语言在线试用</title>

    </head>
    <body>

   <div id="app">
   <nav class="navbar navbar-expand-lg navbar-light bg-light">
   <div class="container-fluid">
    <a class="navbar-brand" href="#">开始</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="http://www.klang.org.cn">主页</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">股票</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            知识
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <li><a class="dropdown-item" href="#">结构</a></li>
            <li><a class="dropdown-item" href="#">指标</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">波浪理论</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">和谐交易</a>
        </li>
      </ul>

    <div class="form-check" style="margin-right:20px;">
    
    <input class="form-check-input" type="checkbox" value="" id="flexbusy" checked disabled>
    <label class="form-check-label" for="flexbusy">
        busy
    </label>
    </div>
    
    <div class="form-check">

    <input class="form-check-input" type="checkbox" value="" id="flexCheckCheckedDisabled" checked disabled>
    <label class="form-check-label" for="flexCheckCheckedDisabled">
        {{usercount}} Online
    </label>


    </div> <!-- form check-->
  </div>
</nav>

<div class="container" style="margin-top:30px;">
  <div class="row">
    <div class="col">
      
            <div >
                <textarea id="content" style="min-height:200px;width:80%"></textarea>
            </div>
            <button type="button" class="btn btn-warning" style="margin-right:30px;"id="reset">Reset</button>
            <button type="button" class="btn btn-primary" id="run">Run</button>
    </div>
    <div class="col">
        <div class="display">
            <table class="table">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">name</th>
      <th scope="col">code</th>
      <th scope="col">值</th>
    </tr>
  </thead>
  <tbody>
    <tr v-for="(item,index) in result">
      <th scope="row" >{{index}}</th>
      <td>{{item.name}}</td>
      <td>{{item.code}}</td>
      <td>{{item.value}}</td>
    </tr>
  </tbody>
</table> 
        </div>
    </div>
  </div>
</div> <!-- container-->

</div> <!-- app for vue-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
     <script src="https://unpkg.com/vue@next"></script>
    <script>

      const VueApp = {
        data() {
            return {
                online:0,
                usercount:0,
                busy:false,
                result:[] 
            }
        },
    
        created() {
        },
        methods: {
        // These methods won't trigger a watcher because we changed only a property of Object/Array,
        // not the Object/Array itself
            changeArticleText() {
                this.article.text = 'Vue 3 is awesome'
            }
        }
      }//VueApp
      window.vue = Vue.createApp(VueApp).mount('#app')

            var run = document.querySelector('#run'),
                reset = document.querySelector('#reset'),
                content = document.querySelector('#content'),
                display = document.querySelector('#display'),
                flexbusy = document.querySelector('#flexbusy'),
                websocket = new WebSocket("ws://127.0.0.1:6789/");
            run.onclick = function (event) {
                if (flexbusy.checked == true){
                    alert("正在执行任务")
                    return
                }
                vue.$data.result = []
                websocket.send(JSON.stringify({action: 'execute',content:content.value,loop:true}));
            }
            reset.onclick = function (event) {
                content.value = ""
            }
            websocket.onmessage = function (event) {
                data = JSON.parse(event.data);
                console.log(data)
                switch (data.type) {
                    case 'busy':
                        if (data.op == false){
                            alert("系统正在执行其他任务，请稍等");
                        }

                        if (data.value == true){
                            flexbusy.checked= true
                        } else {

                            flexbusy.checked= false 
                        }
                        break;
                    case 'users':
                        vue.$data.usercount = data.count
                        vue.$data.online = 1
                        if (data.busy == 0){
                            flexbusy.checked= false 
                        } else {
                            flexbusy.checked= true
                        }
                        break;
                    case 'display':
                        vue.$data.result.push({name:data.name,code:data.code,value:data.value})
                        break;
                    default:
                        console.error(
                            "unsupported event", data);
                }
            };
            websocket.onclose = function (e) {
                    console.log('websocket 断开: ' + e.code + ' ' + e.reason + ' ' + e.wasClean)
                    vue.$data.online = 0
                    vue.$data.usercount = 0
                    $("#flexbusy").checked= false 
            }
 

    </script>

    </body>
</html>
<!--
https://mdbootstrap.com/docs/b5/vue/getting-started/installation/
-->
